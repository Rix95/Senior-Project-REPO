<!-- src/views/Dashboard.vue -->
<template>
  <div>
    <el-card>
      <h2>Vulnerability Trends</h2>
      <!-- The line chart uses our reactive chartData. -->
      <line-chart :chart-data="chartData" :chart-options="chartOptions"></line-chart>
    </el-card>
  </div>
</template>

<script>
import { Line } from 'vue-chartjs'
import { defineComponent, onMounted, ref } from 'vue'
import { Chart, registerables } from 'chart.js'
import { getVulnerabilityTimeline } from '../services/api' // or '../services/api'

Chart.register(...registerables)

export default defineComponent({
  name: 'Dashboard',
  components: {
    lineChart: {
      extends: Line,
      props: ['chartData', 'chartOptions'],
      mounted() {
        this.renderChart(this.chartData, this.chartOptions)
      },
      watch: {
        // If chartData changes after initial load, re-render the chart:
        chartData(newVal) {
          this.renderChart(newVal, this.chartOptions)
        }
      }
    }
  },
  setup() {
    // Reactive chart data
    const chartData = ref({
      labels: [],
      datasets: [
        {
          label: 'Detected Vulnerabilities',
          // You can remove or customize your color as needed:
          backgroundColor: '#f87979',
          data: []
        }
      ]
    })

    const chartOptions = ref({
      responsive: true,
      maintainAspectRatio: false
    })

    onMounted(async () => {
      try {
        // 1) Fetch dynamic data from the new endpoint
        const response = await getVulnerabilityTimeline()
        // response.data should be something like:
        // [ { date: "2025-03-28", count: 15 }, { date: "2025-03-29", count: 22 }, ... ]

        const timelineData = response.data
        // 2) Fill our labels & data arrays from the response
        chartData.value.labels = timelineData.map(item => item.date)
        chartData.value.datasets[0].data = timelineData.map(item => item.count)
      } catch (error) {
        console.error('Error fetching vulnerability timeline:', error)
      }
    })

    return {
      chartData,
      chartOptions
    }
  }
})
</script>
