<template>
  <section>
    <el-row :gutter="20" class="mb-4">
      <el-col :span="8"><el-card><h3>Total Vulnerabilities</h3><p class="stat">{{ total }}</p></el-card></el-col>
      <el-col :span="8"><el-card><h3>Last Updated</h3><p>{{ lastUpdated }}</p></el-card></el-col>
    </el-row>

    <el-card>
      <h2>Vulnerability Trends</h2>
      <line-chart :chart-data="chartData" :chart-options="chartOptions" class="chart"/>
    </el-card>
  </section>
</template>

<script setup>
import { Line }       from 'vue-chartjs'
import { onMounted, ref } from 'vue'
import { Chart, registerables } from 'chart.js'
import {
  getVulnerabilityTimeline,
  getVulnerabilityCount,
  getLastUpdated,
} from '../services/api'

Chart.register(...registerables)

const total       = ref('...')
const lastUpdated = ref('...')
const chartData   = ref({ labels: [], datasets: [] })
const chartOptions= { responsive: true, maintainAspectRatio: false }

const LineChart = {
  extends: Line,
  props: ['chartData','chartOptions'],
  mounted() { this.renderChart(this.chartData, this.chartOptions) },
  watch: {
    chartData (val) { this.renderChart(val, this.chartOptions) }
  }
}

onMounted(async () => {
  const [{ data: count }, { data: updated }, { data: timeline }] = await Promise.all([
    getVulnerabilityCount(), getLastUpdated(), getVulnerabilityTimeline(),
  ])

  total.value       = count.total_vulnerabilities.toLocaleString()
  lastUpdated.value = new Date(+updated.last_updated).toLocaleString()

  // **Reâ€‘create** the object so the watch() above fires reliably
  chartData.value = {
    labels: timeline.map(d => d.date),
    datasets:[{ label:'Detected', backgroundColor:'#f87979', data: timeline.map(d=>d.count) }]
  }
})
</script>

<style scoped>
.stat { font-size:2.4rem; color:#e74c3c }
.chart{ height:360px; }
</style>
